\documentclass[20pt,landscape,a4paper,footrule]{foils}
%\usepackage{solido-network-slides}
\usepackage{zencurity-slides}



% Original description in danish sorry
% Foredrag: Forsvar dit netværk med Nmap
% --------------------------------------
% En hel aften med Nmap pakken af værktøjer som gør dig istand til at
% beskytte dit netværk bedre, fordi du effektivt kan undersøge det.
%
% Vi gennemgår almindelig portscanning, som sættes i system, samt andre
% værktøjer som Nping til verifikation af forbindelser mellem enheder og
% igennem filtre og firewalls.
%
% Der er ikke krav om dybt kendskab til TCP/IP men emner som
% SYN-SYN/ACK-ACK gennemgås. Foredraget vil være specielt interessant
% for firewall administratorer og serverfolk.

% Der vil være indlagt nogle små opgaver hvor du kan prøve at afvikle et
% NSE script, enten ved at kopiere mit eksempel, eller lave en lidt
% sværere opgave.
%
% Nøgleord:
% Nmap, portscanning, dagens exploitscan, TCP, UDP, ICMP, IKE, scripting


% Basic things that we need are below
\selectlanguage{danish}

%\externaldocument{unix-audit-security-oevelser}
\externaldocument{\jobname-exercises}

\begin{document}

% Switch font to dyslexic
\rm
\selectlanguage{english}
\mytitlepage
{Nmap Hackerworkshop}
{An evening with Nmap}

\LogoOn

%\dagsplan


\slide{Goal}
\vskip 2 cm

%{\hlkbig En 3 dages workshop, hvor du lærer at angribe dit netværk!}
\hlkimage{3cm}{dont-panic.png}
\centerline{\color{titlecolor}\LARGE Don't Panic!}

Spend an evening using Nmap tools, multiple tools:
\begin{list1}
\item Try different scan types from graphical Zenmap and command line
\item Try different tools like Nping, Ndiff
\item Practice real-life scenarios
\item Enable you to do quality port scans!
\item NOTE: please read the notes for each exercise, important information!
\end{list1}


\slide{Hackertools}

\begin{list1}
\item First published \emph{Improving the Security of Your Site by Breaking Into it}
Dan Farmer og Wietse Venema in 1993
\item Published in 1995 then a software package SATAN
\emph{Security Administrator Tool for Analyzing Networks}
\item Caused quite a stir and panic, {\it everybody can hack, the internet will break}

\vskip 1cm
\begin{quote}
We realize that SATAN is a two-edged sword -- like
many tools, it can be used for good and for evil
purposes. We also realize that intruders (including
wannabees) have much more capable (read intrusive)
tools than offered with SATAN.
\end{quote}
\end{list1}

\vskip 1cm
Source:
\link{http://www.fish2.com/security/admin-guide-to-cracking.html}


\slide{DK Law - Aftale om test af netværk}

{\bfseries Straffelovens paragraf 263 Stk. 2. Med bøde eller fængsel indtil 1 år og 6 måneder straffes den, der uberettiget skaffer sig adgang til en andens oplysninger eller programmer, der er bestemt til at bruges i et informationssystem. }

Hacking kan betyde:
\begin{list2}
\item At man skal betale erstatning til personer eller virksomheder
\item At man får konfiskeret sit udstyr af politiet
\item At man, hvis man er over 15 år og bliver dømt for hacking, kan
  få en bøde -- eller fængselsstraf i alvorlige tilfælde
\item At man, hvis man er over 15 år og bliver dømt for hacking, får
en plettet straffeattest. Det kan give problemer, hvis man skal finde
et job eller hvis man skal rejse til visse lande, fx USA og
Australien
\item Frygten for terror har forstærket ovenstående -- så lad være!
\end{list2}


\slide{Use hackertools!}

\begin{list1}
\item Hackertools -- Using them already? -- should use them after this course
\item Portscans show potential access to your network
\item Web test tools and scanners can crawl a site and report problems
\item Lots of potential weaknesses can be found proactively by using these tools regularly
\item Note: penetration testing is not a silverbullet
\item Honeypots can also be used to setup traps for attackers
\end{list1}

\slide{Hackertools are for everyone!}

\hlkimage{2cm}{hackers_JOLIE+1995.jpg}


\begin{list2}
\item Hackers work all the time to break stuff, Use hackertools:
\item Nmap, Nping \link{http://nmap.org}
\item Wireshark - \link{http://www.wireshark.org/}
\item Aircrack-ng \link{http://www.aircrack-ng.org/}
\item Metasploit Framework \link{http://www.metasploit.com/}
\item Burpsuite \link{http://portswigger.net/burp/}
\item Skipfish \link{http://code.google.com/p/skipfish/}
\item Kali Linux \link{http://www.kali.org}
\end{list2}

\vskip 5mm
\centerline{Most popular hacker tools \link{http://sectools.org/}}



\slide{Kali Linux the pentest toolbox}

\hlkimage{\linewidth-10cm}{kali-linux.png}

\begin{list1}
\item  Kali \link{http://www.kali.org/} brings together 100s of tools
\item 100.000s of videos on youtube alone, searching for kali and \$TOOL
\item Also versions for Raspberry Pi, mobile and other small computers
\item Other pentesting Linux distributions exist, but Kali is very popular
\end{list1}

\slide{Hackerlab setup}

\hlkimage{10cm}{hacklab-1.png}

\begin{list2}
\item Hardware: most modern laptops has CPU with virtualization \\
May need to enale it in BIOS
\item Software: use your favorite operating system, Windows, Mac, Linux
\item Virtualization software: VMware, Virtual box, choose your poison
\item Hackersoftware: Kali as a Virtual Machine \link{https://www.kali.org/}
\item Install soft targets: Metasploitable, Windows 2000, Windows XP, ...
\end{list2}

\exercise{ex:wireshark-install}

\exercise{ex:nmap-install}

\slide{Scope: select systems for testing}

%\hlkimage{14cm}{images/demo-netvaerk.pdf}
\hlkimage{13cm}{overview-routing-customer-2015.png}

\begin{list1}
\item Typical scope targets:
\begin{list2}
\item Routers in front of critical systems and networks - availability
\item Firewalls -- are traffic flows restricted
\item Mail servers -- open for relaying
\item Web servers -- remote code execution in web systems, data download
\end{list2}
\end{list1}


\slide{Halt testing -- compromised servers}

\begin{list1}
\item There can be reason for halting a penetration test
\item You should stop testing when:
\begin{list2}
\item Breached and compromised systems are found. Dont mess up evidence
\item Network is bad, testing will not show correct results
\end{list2}
\item or if the customer wants to halt testing:
\begin{list2}
\item Problems when performing the test
\item Crashes in critical systems
\item Other crises demand attention
\end{list2}
\item NB: examples only! -- always stop testing if customers ask!
\end{list1}


\slide{Reporting -- results}

\begin{list1}
\item What is in a pentest report:
\begin{list2}
\item Title, Table of contents, -- total. 15-30 pages for 5 hosts
\item Confidentiality agreement -- Write "Confidential" on each page
\item Executive summary -- big companies always want this
\item Information about the scan done, what was it
\item Scope and targets
\item Review of all targets -- detailed information and recommendations
\item Conclusion -- may be more technical
\item Appendices -- various information, Whois info about subnets and prefixes
\end{list2}
\item It is the organisation that ultimately decides which recommendations to follow
\end{list1}


\slide{What happens now?}

\begin{list1}
\item Think like a hacker
\item Recon phase -- gather information reconnaissance
\begin{list2}
\item Traceroute, Whois, DNS lookups
\item Ping sweep, port scan
\item OS detection -- TCP/IP and banner grabbing
\item Service scan -- rpcinfo, netbios, ...
\item telnet/netcat interact with services
\end{list2}
\end{list1}

\centerline{Today focus on Nmap and processes around portscanning}


\slide{Internet today}

\hlkimage{14cm}{images/server-client.pdf}

\begin{list1}
\item Clients and serves
\item Roots in academia
\item Protocols more than 20 years old
\item HTTP is becoming encrypted, but a lot other traffic is not
\end{list1}

\slide{Trinity breaking in}

\hlkimage{18cm}{trinity-nmapscreen-hd-cropscale-418x250.jpg}
Nmap has been featured in twelve movies:\\
\link{https://nmap.org/movies/}\\
\link{https://youtu.be/51lGCTgqE_w}



\slide{what is Nmap today}
\begin{quote}
Nmap ("Network Mapper") is a free and open source (license) utility for network discovery and security auditing.
\end{quote}

\begin{list1}
\item Initial release September 1997; 20 years ago
\item Today a package of programs for Windows, Mac, BSD, Linux, ... source
\item Flexible, powerful, and free!
\item Lets check release notes, 7.70 pt.
http://seclists.org/nmap-announce/2018/0
\end{list1}

Bonus info: you can help Nmap by submitting fingerprints

\slide{OSI og Internet modellerne}

\hlkimage{14cm,angle=90}{images/compare-osi-ip.pdf}

\slide{Wireshark -- capture and dissect network packets}

\hlkimage{20cm}{images/wireshark-website.png}

\centerline{\link{https://www.wireshark.org}}

\slide{Using Wireshark}

\hlkimage{18cm}{images/wireshark-http.png}

\centerline{Filtering is a basic but advanced function}

\slide{Network mapping}

\hlkimage{13cm}{images/network-example.pdf}

\begin{list1}
\item Using traceroute and similar programs it is often possible to make educated guess to network topology
\item Time to live (TTL) for packets are decreased when crossing a router
\item when it reaches zero the packet is timed out, and ICMP message sent back to source
\item Default Unix traceroute uses UDP, Windows tracert use ICMP
\end{list1}


\slide{traceroute -- UDP}

\begin{alltt}
\footnotesize # {\bfseries tcpdump -i en0 host 10.20.20.129 or host 10.0.0.11}
tcpdump: listening on en0
23:23:30.426342 10.0.0.200.33849 > router.33435: udp 12 {\bf [ttl 1]}
23:23:30.426742 safri > 10.0.0.200: {\bf icmp: time exceeded in-transit}
23:23:30.436069 10.0.0.200.33849 > router.33436: udp 12 {\bf [ttl 1]}
23:23:30.436357 safri > 10.0.0.200: {\bf icmp: time exceeded in-transit}
23:23:30.437117 10.0.0.200.33849 > router.33437: udp 12 {\bf [ttl 1]}
23:23:30.437383 safri > 10.0.0.200: {\bf icmp: time exceeded in-transit}
23:23:30.437574 10.0.0.200.33849 > router.33438: udp 12
23:23:30.438946 router > 10.0.0.200: icmp: router {\bf udp port 33438 unreachable}
23:23:30.451319 10.0.0.200.33849 > router.33439: udp 12
23:23:30.452569 router > 10.0.0.200: icmp: router {\bf udp port 33439 unreachable}
23:23:30.452813 10.0.0.200.33849 > router.33440: udp 12
23:23:30.454023 router > 10.0.0.200: icmp: router {\bf udp port 33440 unreachable}
23:23:31.379102 10.0.0.200.49214 > safri.domain:  6646+ PTR?
200.0.0.10.in-addr.arpa. (41)
23:23:31.380410 safri.domain > 10.0.0.200.49214:  6646 NXDomain* 0/1/0 (93)
14 packets received by filter
0 packets dropped by kernel
\end{alltt}

\vskip 5mm
\centerline{Low TTL, UDP, high ports above 33000 = Unix traceroute signature}

\slide{Basic port scanning}

\begin{list1}
\item What is a port scan
\item Testing all values possible for port number from 0/1 to 65535
\item Goal is to identify open ports, listening and vulnerable services
\item Most often TCP og UDP scan
\item TCP scanning is more realiable than UDP scanning
\item TCP handshake must respond with SYN-ACK packets
\item UDP applications respond differently -- if they even respond\\
so probes with real requests may get response, no firewall they respond withb ICMP on closed ports
\item Use the GUI program Zenmap while learning Nmap
\end{list1}

\slide{TCP three-way handshake}

\hlkimage{6cm}{images/tcp-three-way.pdf}

\begin{list2}
\item {\bfseries TCP SYN half-open} scans
\item in the old days systems would only log when a full TCP connection was setup\\
  -- so doing only half open it was a \emph{stealth}-scans
\item Today system and IDS intrusion detection can easily monitor for this
\item Sending a lot of SYN packets can create a Denial of Service -- {\bfseries SYN-flooding}
\end{list2}


\exercise{ex:whois-dns}

\exercise{ex:wireshark-capture}


\slide{Ping and port sweep}

\begin{list1}
\item Scans across the network are named sweeps
\item Ping sweeps using ICMP Ping probes
\item Port sweep trying to find a specific service, like port 80 web
\item Quite easy to see in network traffic:
\begin{list2}
\item Selecting two IP-adresser not in use
\item Should not see any traffic, but if it does, its being scanned
\item If traffic is received on both addresses, its a sweep -- if they are a bit apart it is even better, like 10.0.0.100 and 10.0.0.200
  \end{list2}

\vskip 2cm
Pro tip: a Great network intrusion detection engine (IDS), is Suricata \link{suricata-ids.org}
\end{list1}

\slide{Nmap port sweep for web servers}

\begin{alltt}\small
root@cornerstone:~#{\bfseries  nmap -p80,443 172.29.0.0/24}

Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:31 CET
Nmap scan report for 172.29.0.1
Host is up (0.00016s latency).
PORT    STATE    SERVICE
{\color{darkgreen}80/tcp  open     http}
443/tcp filtered https
MAC Address: 00:50:56:C0:00:08 (VMware)

Nmap scan report for 172.29.0.138
Host is up (0.00012s latency).
PORT    STATE  SERVICE
{\color{darkgreen}80/tcp  open   http}
443/tcp closed https
MAC Address: 00:0C:29:46:22:FB (VMware)

\end{alltt}

\slide{Nmap port sweep for SNMP port 161/UDP}

\begin{alltt}\small
root@cornerstone:~#{\bfseries nmap -sU -p 161 172.29.0.0/24}
Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:30 CET
Nmap scan report for 172.29.0.1
Host is up (0.00015s latency).
PORT    STATE         SERVICE
{\color{darkgreen}161/udp open|filtered snmp}
MAC Address: 00:50:56:C0:00:08 (VMware)

Nmap scan report for 172.29.0.138
Host is up (0.00011s latency).
PORT    STATE  SERVICE
{\bf{161/udp closed snmp}}
MAC Address: 00:0C:29:46:22:FB (VMware)
...
Nmap done: 256 IP addresses (5 hosts up) scanned in 2.18 seconds
\end{alltt}

\vskip 5mm
\centerline{More reliable to use Nmap script with probes like --script=snmp-info}

\slide{Nmap Advanced OS detection}
\begin{alltt}\footnotesize
root@cornerstone:~#{\bfseries nmap -A -p80,443 172.29.0.0/24}
Starting Nmap 6.47 ( http://nmap.org ) at 2015-02-05 07:37 CET
Nmap scan report for 172.29.0.1
Host is up (0.00027s latency).
PORT    STATE    SERVICE VERSION
80/tcp  open     http    Apache httpd 2.2.26 ((Unix) DAV/2 mod_ssl/2.2.26 OpenSSL/0.9.8zc)
|_http-title: Site doesn't have a title (text/html).
443/tcp filtered https
MAC Address: 00:50:56:C0:00:08 (VMware)
Device type: media device|general purpose|phone
Running: Apple iOS 6.X|4.X|5.X, Apple Mac OS X 10.7.X|10.9.X|10.8.X
OS details: Apple iOS 6.1.3, Apple Mac OS X 10.7.0 (Lion) - 10.9.2 (Mavericks)
or iOS 4.1 - 7.1 (Darwin 10.0.0 - 14.0.0), Apple Mac OS X 10.8 - 10.8.3 (Mountain Lion)
or iOS 5.1.1 - 6.1.5 (Darwin 12.0.0 - 13.0.0)
OS and Service detection performed.
Please report any incorrect results at http://nmap.org/submit/
\end{alltt}

\begin{list2}
\item Low-level way to identify operating systems, also try/use
  \verb+nmap -A+
\item Send probes and observe responses, lookup in table of known OS and responses
\item Techniques known since at least: \emph{ICMP Usage In Scanning} Version 3.0,
  Ofir Arkin, 2001 %\link{https://web.archive.org/web/20050210093427/http://www.sys-security.com/html/projects/icmp.html} % Original side er død
\end{list2}

\slide{Portscan using Zenmap GUI}

\hlkimage{15cm}{nmap-zenmap.png}
\centerline{Zenmap included in the full Nmap package \link{https://nmap.org}}


\exercise{ex:nmap-pingsweep}

\exercise{ex:nmap-synscan}

\exercise{ex:nmap-os}

\exercise{ex:nmap-service}

\exercise{ex:nmap-strategy}

\slide{Experiences gathered}

\begin{list1}
\item Lots of information
\item Reveals a lot about the network, operating systems, services etc.
\item I use a template when getting data
  \begin{list2}
    \item Respond to ICMP: $\Box$\  echo, $\Box$\ mask, $\Box$\ time
\item Respond to traceroute: $\Box$\ ICMP, $\Box$\ UDP
\item Open ports TCP og UDP:
\item Operating system:
\item ... (banner information )
  \end{list2}
\item Beware when doing scans it is possible to make routers, firewalls and devices perform badly or even crash!
\end{list1}

\exercise{ex:nmap-html}

\exercise{ex:nping-tcp}

% Måske shellshock og heartbleed

\slide{Heartbleed CVE-2014-0160}

\hlkimage{22cm}{heartbleed-com.png}

Source: \link{http://heartbleed.com/}

\slide{Heartbleed is yet another bug in SSL products}

\begin{alltt}
What versions of the OpenSSL are affected?
Status of different versions:

* OpenSSL 1.0.1 through 1.0.1f (inclusive) are vulnerable
* OpenSSL 1.0.1g is NOT vulnerable
* OpenSSL 1.0.0 branch is NOT vulnerable
* OpenSSL 0.9.8 branch is NOT vulnerable

Bug was introduced to OpenSSL in December 2011 and has been out
in the wild since OpenSSL release 1.0.1 on 14th of March
2012. OpenSSL 1.0.1g released on 7th of April 2014 fixes the bug.
\end{alltt}

\vskip 1cm
\centerline{It's just a bug - but a serious one}

\slide{Heartbleed hacking}

\begin{alltt}\footnotesize
  06b0: 2D 63 61 63 68 65 0D 0A 43 61 63 68 65 2D 43 6F  -cache..Cache-Co
  06c0: 6E 74 72 6F 6C 3A 20 6E 6F 2D 63 61 63 68 65 0D  ntrol: no-cache.
  06d0: 0A 0D 0A 61 63 74 69 6F 6E 3D 67 63 5F 69 6E 73  ...action=gc_ins
  06e0: 65 72 74 5F 6F 72 64 65 72 26 62 69 6C 6C 6E 6F  ert_order&billno
  06f0: 3D 50 5A 4B 31 31 30 31 26 70 61 79 6D 65 6E 74  =PZK1101&payment
  0700: 5F 69 64 3D 31 26 63 61 72 64 5F 6E 75 6D 62 65  _id=1&{\bf card_numbe}
  0710: XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX  {\bf r=4060xxxx413xxx}
  0720: 39 36 26 63 61 72 64 5F 65 78 70 5F 6D 6F 6E 74  {\bf 96&card_exp_mont}
  0730: 68 3D 30 32 26 63 61 72 64 5F 65 78 70 5F 79 65  {\bf h=02&card_exp_ye}
  0740: 61 72 3D 31 37 26 63 61 72 64 5F 63 76 6E 3D 31  {\bf ar=17&card_cvn=1}
  0750: 30 39 F8 6C 1B E5 72 CA 61 4D 06 4E B3 54 BC DA  {\bf 09}.l..r.aM.N.T..
\end{alltt}

\begin{list2}
\item Obtained using Heartbleed proof of concepts -- Gave full credit card details
\item "Can XXX be exploited" -- yes, clearly! PoCs ARE needed\\
Without PoCs even Akamai wouldn't have repaired completely!
\item The internet was ALMOST fooled into thinking getting private keys\\
 from Heartbleed was not possible -- scary indeed.
\end{list2}


\slide{Scan for Heartbleed and SSLv2/SSLv3}

\hlkimage{8cm}{nmap-sslv2.png}

\begin{list1}
\item \verb+nmap -p 443 --script ssl-heartbleed <target>+\\
\link{https://nmap.org/nsedoc/scripts/ssl-heartbleed.html}
\item \verb+masscan 0.0.0.0/0 -p0-65535  --heartbleed+\\
\link{https://github.com/robertdavidgraham/masscan}
\end{list1}

\centerline{Almost every new vulnerability will have Nmap recipe}

\exercise{ex:nmap-nse}

\exercise{ex:nmap-write-nse}

\slide{Defense in depth - multiple layers of security}

\hlkimage{7cm}{security-layers-1-uk.pdf}

\centerline{Multiple layers of security! }


\slide{The Exploit Database}

\hlkimage{20cm}{exploit-db.png}

\centerline{\link{http://www.exploit-db.com/}}


\slide{Metasploit and Armitage Still rocking the internet}

%\hlkimage{20cm}{metasploit-about.png}
\hlkimage{8cm}{armitage-overview.png}

\begin{list1}
\item \link{http://www.metasploit.com/}
\item Armitage GUI fast and easy hacking for Metasploit\\
\link{http://www.fastandeasyhacking.com/}
\item Recommened training Metasploit Unleashed\\
\link{http://www.offensive-security.com/metasploit-unleashed/Main_Page}
%\item Bog: Metasploit: The Penetration Tester's Guide, No Starch Press\\
%ISBN-10: 159327288X
\end{list1}

\slide{Demo: Metasploit Armitage }

\hlkimage{16cm}{armitage-overview.png}

\exercise{ex:dbnmap}

\slide{Security devops}

\begin{list1}
\item We need devops skillz in security
\item automate, security is also big data
\item integrate tools, transfer, sort, search, pattern matching, statistics, ...
\item tools, languages, databases, protocols, data formats
\item Use Github! So many libraries and programs that can help, maybe solve  90\% of your problem, and you can glue the rest together
\item Example introductions:
\begin{list2}
\item Seven languages/database/web frameworks in Seven Weeks
\item Elasticsearch the definitive guide
\end{list2}
\end{list1}

\centerline{We are all Devops now, even security people!}

\myquestionspage

\end{document}
