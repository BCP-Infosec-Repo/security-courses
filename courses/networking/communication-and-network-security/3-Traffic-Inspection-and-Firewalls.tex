\documentclass[Screen16to9,17pt]{foils}
\usepackage{zencurity-slides}

\externaldocument{communication-and-network-security-exercises}
\selectlanguage{english}

\begin{document}

\mytitlepage
{3. Traffic Inspection and Firewalls}
{Communication and Network Security 2019}

\slide{Plan for today}

\begin{list1}
\item Subjects
\begin{list2}
\item Traffic inspection and firewalls
\item Generic IP Firewalls stateless filtering vs stateful inspection
\item Next Generation firewalls, Deep Packet Inspection
\item  IEEE 802.1q VLAN
\item Common countermeasures in firewalls
\end{list2}
\item Exercises
\begin{list2}
\item Nmap scanning firewalls
\end{list2}
\end{list1}

\slide{Reading Summary}

\begin{quote}
ANSM chapter 1,2,3 - 73 pages\\
\link{https://en.wikipedia.org/wiki/Firewall_(computing)}\\
\link{http://www.wilyhacker.com/} Cheswick chapter 2 og 3 PDF, ca 55 pages
  Skim chapters from 1st edition:\\
\link{http://www.wilyhacker.com/1e/chap03.pdf}\\ \link{http://www.wilyhacker.com/1e/chap04.pdf}
\end{quote}

\begin{quote}
The next time you are at your console, review some logs. You might think. . . “I
don’t know what to look for". Start with what you know, understand, and don’t care about. Discard those. Everything else is of interest.\\
Semper Vigilans,
Mike Poor
\end{quote}

\slide{Reading Summary, continued}

\hlkimage{7cm}{NSM_Phases-300x238.png}

\begin{list1}
\item ANSM chapter 1: The Practice of Applied
Network Security Monitoring
\begin{list2}
\item Vulnerability-Centric vs. Threat-Centric Defense
\item The NSM cycle: collection, detection, and analysis
\item Full Content Data, Session Data, Statistical Data, Packet String Data, and Alert Data
\item Security Onion is nice, but a bit over the top - quickly gets overloaded
\end{list2}
\end{list1}

\slide{Baseline Skills}

\begin{list2}\small
\item Threat-Centric Security, NSM, and the NSM Cycle
\item TCP/IP Protocols
\item Common Application Layer Protocols
\item Packet Analysis
\item Windows Architecture
\item Linux Architecture
\item Basic Data Parsing (BASH, Grep, SED, AWK, etc)
\item IDS Usage (Snort, Suricata, etc.)
\item Indicators of Compromise and IDS Signature Tuning
\item Open Source Intelligence Gathering
\item Basic Analytic Diagnostic Methods
\item Basic Malware Analysis
\end{list2}

Source: \emph{Applied Network Security Monitoring Collection, Detection, and Analysis}, Chris Sanders and Jason Smith

\slide{Reading Summary, continued}

\hlkimage{13cm}{ansm-acf.png}

\begin{list1}
  \item ANSM chapter 2: Planning Data Collection
\begin{list2}
\item The Applied Collection Framework (ACF)
\item The ACF involves four distinct phases: Identify
threats to your organization, quantify risk, identify relevant data feeds, and refine the useful elements
\item Risk Analysis
\item Lots of terms used, but only defined later in the book
\end{list2}
\end{list1}

\slide{Reading Summary, continued}

\begin{alltt}\footnotesize

\end{alltt}

\begin{list1}
\item ANSM chapter 3:The Sensor Platform
\begin{list2}
\item Full Packet Capture (FPC) Data
\item Session Data
\item Statistical Data
\item Packet String (PSTR) Data
\item Log Data
\item Sensor Placement, designing etc.
\end{list2}
\end{list1}



\slide{Reading Summary, continued}

\begin{quote}
In computing, a firewall is a network security system that monitors and controls incoming and outgoing network traffic based on predetermined security rules.[1] A firewall typically establishes a barrier between a trusted internal network and untrusted external network, such as the Internet.[2]
\end{quote} Source: Wikipedia

\begin{list1}
\item \link{https://en.wikipedia.org/wiki/Firewall_(computing)}
\item \link{http://www.wilyhacker.com/} Cheswick chapter 2 PDF
\emph{A Security Review of Protocols:
Lower Layers}
\begin{list2}
\item Network layer, packet filters, application level, stateless, stateful
\end{list2}
\end{list1}

\Large Firewalls are by design a choke point, natural place \\
to do network security monitoring!

\slide{Reading Summary, continued}

\begin{quote}

\end{quote} Source:

\begin{list1}
\item \link{http://www.wilyhacker.com/} Cheswick chapter 3 PDF
\emph{Security Review: The Upper Layers}
\begin{list2}
\item How to configure firewalls often boil down to, should we allow protocol X
\item If we allow SMB through an internet firewall, we are asking for trouble
\end{list2}
\end{list1}

Skim chapters from 1st edition:\\
\link{http://www.wilyhacker.com/1e/chap03.pdf}\\ \link{http://www.wilyhacker.com/1e/chap04.pdf}


\slide{Together with Firewalls - VLAN Virtual LAN}

\hlkimage{6cm}{vlan-portbased.pdf}

\begin{list1}
\item Nogle switche tillader at man opdeler portene
\item Denne opdeling kaldes VLAN og portbaseret er det mest simple
\item Port 1-4 er et LAN
\item De resterende er et andet LAN
\item Data skal omkring en firewall eller en router for at krydse fra VLAN1 til VLAN2
\end{list1}

\slide{IEEE 802.1q}

\hlkimage{16cm}{vlan-8021q.pdf}

\begin{list1}
\item Med 802.1q tillades VLAN tagging på Ethernet niveau
\item Data skal omkring en firewall eller en router for at krydse fra VLAN1 til VLAN2
\item VLAN trunking giver mulighed for at dele VLANs ud på flere switches
\end{list1}


\slide{Connecting clients more securely}

IEEE 802.1x  Port Based Network Access Control

\hlkimage{10cm}{osx-8021x.png}

\begin{list1}
\item Denne protokol sikrer at man valideres før der gives adgang til porten
\item Når systemet skal have adgang til porten afleveres brugernavn og kodeord/certifikat
\end{list1}


\slide{802.1x og andre teknologier}

\begin{list1}
\item 802.1x i forhold til MAC filtrering giver væsentlige fordele
\item MAC filtrering kan spoofes, hvor 802.1x kræver det rigtige kodeord
\item Typisk benyttes RADIUS og 802.1x integrerer således mod både LDAP og Active Directory
\end{list1}


\slide{Generic IP Firewalls}

\vskip 4 cm
\centerline{\hlkbig En firewall er noget som {\color{security6blue}blokerer}
  traffik på Internet}

\vskip 1 cm
\pause

\centerline{\hlkbig En firewall er noget som {\color{red}tillader}
  traffik på Internet}

\slide{Firewallrollen idag}

\begin{list1}
\item Idag skal en firewall være med til at:
\begin{list2}
\item Forhindre angribere i at komme ind
\item Forhindre angribere i at sende traffik ud
\item Forhindre virus og orme i at sprede sig i netværk
\item Indgå i en samlet løsning med ISP, routere, firewalls, switchede
  strukturer, intrusion detectionsystemer samt andre dele af infrastrukturen
\end{list2}
\item Det kræver overblik!
\end{list1}



\slide{Modern Firewalls}

\begin{list1}
\item Basalt set et netværksfilter - det yderste fæstningsværk
\item Indeholder typisk:
  \begin{list2}
   \item Grafisk brugergrænseflade til konfiguration - er det en
   fordel?
\item TCP/IP filtermuligheder - pakkernes afsender, modtager, retning
  ind/ud, porte, protokol, ...
\item både IPv4 og IPv6
\item foruddefinerede regler/eksempler - er det godt hvis det er nemt
  at tilføje/åbne en usikker protokol?
\item typisk NAT funktionalitet indbygget
\item typisk mulighed for nogle serverfunktioner: kan agere
  DHCP-server, DNS caching server og lignende
  \end{list2}
\item En router med Access Control Lists - kaldes ofte netværksfilter,
  mens en dedikeret maskine kaldes firewall
%  funktionen er reelt den samme - der filtreres traffik
\end{list1}


\slide{Sample rules from OpenBSD PF}

\begin{alltt}\tiny
# hosts and networks
router="217.157.20.129"
webserver="217.157.20.131"
homenet="{ 192.168.1.0/24, 1.2.3.4/24 }"
wlan="10.0.42.0/24"
wireless=wi0
set skip lo0
# things not used
spoofed="{ 127.0.0.0/8, 172.16.0.0/12, 10.0.0.0/16, 255.255.255.255/32 }"
{\bf
block in all # default block anything}
# egress and ingress filtering - disallow spoofing, and drop spoofed
block in quick from $spoofed to any
block out quick from any to $spoofed

pass in on $wireless proto tcp from \{ $wlan $homenet \} to any port = 22
pass in on $wireless proto tcp from any to $webserver port = 80

pass out
\end{alltt}

\slide{netdesign - med firewalls}

\hlkimage{10cm}{images/kut.jpg}

\begin{list2}
\item Hvor skal en firewall placeres for at gøre størst nytte?
\item Hvad er forudsætningen for at en firewall virker?\\
At der er konfigureret et sæt fornuftige regler!
\item Hvor kommer reglerne fra? Sikkerhedspolitikken!
\end{list2}


{\small Kilde: \link{http://www.ranum.com/pubs/a1fwall/} The ULTIMATELY Secure Firewall}
%\href
%{http://www.ranum.com/security/computer\_security/papers/a1-firewall/}
%{http://www.ranum.com/security/computer_security/papers/a1-firewall/}
% old link:




\slide{Packet filtering}

\begin{alltt}\footnotesize
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{alltt}

\begin{list1}
\item Packet filtering er firewalls der filtrerer på IP niveau
\item Idag inkluderer de fleste statefull inspection
\end{list1}

\slide{Kommercielle firewalls}
\begin{list2}
\item Checkpoint Firewall-1 \link{http://www.checkpoint.com}
\item Cisco ASA \link{http://www.cisco.com}
\item Clavister firewalls \link{http://www.clavister.com}
\item Juniper SRX
  \link{http://www.juniper.net}
\end{list2}

Ovenstående er dem som jeg oftest ser ude hos mine kunder

\slide{Open source baserede firewalls}
\begin{list2}
\item Linux firewalls IP tables, use command line tool ufw Uncomplicated Firewall!
\item Firewall GUIs ovenpå Linux - mange!
nogle er kommercielle produkter
\item OpenBSD PF
\link{http://www.openbsd.org}
\item FreeBSD IPFW og IPFW2 \link{http://www.freebsd.org}
\item Mac OS X benytter OpenBSD PF
\item FreeBSD inkluderer også OpenBSD PF
\end{list2}

NB: kun eksempler og dem jeg selv har brugt


\slide{Hardware eller software}


\begin{list1}
\item Man hører indimellem begrebet \emph{hardware firewall}
\item Det er dog et faktum at en firewall består af:
\begin{list2}
\item Netværkskort - som er hardware
\item Filtreringssoftware - som er \emph{software}!
\end{list2}
\item Det giver ikke mening at kalde en Zyxel 10 en hardware firewall
  og en Soekris med OpenBSD for en software firewall!
\item Det er efter min mening et marketingtrick
\vskip 1 cm
\item Man kan til gengæld godt argumentere for at en dedikeret
  firewall som en separat enhed kan give bedre sikkerhed
\end{list1}

\slide{TCP three way handshake}
.
\hlkrightpic{7cm}{0cm}{images/tcp-three-way.pdf}

\begin{list2}
\item {\bfseries TCP SYN half-open} scans
\item Tidligere loggede systemer kun når der var etableret en fuld TCP
  forbindelse - dette kan/kunne udnyttes til \emph{stealth}-scans
\item Hvis en maskine modtager mange SYN pakker kan dette fylde
  tabellen over connections op - og derved afholde nye forbindelser
  fra at blive oprette - {\bfseries SYN-flooding}
\end{list2}




\slide{Firewall er ikke alene}

\hlkimage{15cm}{network-layers-1.png}

\centerline{\hlkbig Forsvaret er som altid - flere lag af sikkerhed! }


\slide{Firewall historik}

\hlkimage{4cm}{images/cheswick-cover2e.jpg}

\begin{list1}
\item Firewalls har været kendt siden starten af 90'erne
\item Første bog \emph{Firewalls and Internet Security}
William R. Cheswick, Steven M. Bellovin, Aviel D. Rubin,
Addison-Wesley, 2nd edition, 2003
\item Bogen udkom i 1994 men kan stadig anbefales
\end{list1}


\slide{m0n0wall}

\hlkimage{6cm}{images/m0n0wall-1.pdf}

\begin{list1}
\item Tidlig firewall bygget på FreeBSD
\item Idag erstattet af pfSense \link{https://www.pfsense.org/}\\
og OPNsense \link{https://opnsense.org/}
\item De nye bruges i produktion i danske firmaer
\end{list1}

\slide{First or Last match firewall?}

\hlkimage{18cm}{images/first-last-match-1.pdf}


\slide{firewall koncepter}

\begin{list1}
\item Rækkefølgen af regler betyder noget!
\begin{list2}
\item To typer af firewalls:
 First match - når en regel matcher, gør det som angives block/pass
 Last match  - marker pakken hvis den matcher, til sidst afgøres block/pass
\end{list2}
\item {\bf Det er ekstremt vigtigt at vide hvilken type firewall
    man bruger!}
\item OpenBSD PF er last match
\item FreeBSD IPFW er first match
\item Linux iptables/netfilter er last match
\end{list1}

\slide{First or Last match firewall?}

\hlkimage{18cm}{images/first-last-match-1.pdf}



\slide{First match - IPFW}

\begin{alltt}
\hlksmall
00100 16389  1551541 allow ip from any to any via lo0
00200     0        0 deny log ip from any to 127.0.0.0/8
00300     0        0 check-state
...
{\bfseries
65435    36     5697 deny log ip from any to any}
65535   865    54964 allow ip from any to any
\end{alltt}

\vskip 2 cm

\centerline{Den sidste regel nås aldrig!}

\slide{Last match - OpenBSD PF}

\begin{alltt}\small
ext_if="ext0"
int_if="int0"
{\bf
block in}
pass out keep state

pass quick on \{ lo $int_if \}

# Tillad forbindelser ind på port 80=http og port 53=domain
# på IP-adressen for eksterne netkort ($ext_if) syntaksen
pass in on $ext_if proto tcp to ($ext_if) port http keep state
pass in on $ext_if proto \{ tcp, udp \} to ($ext_if) port domain keep state
\end{alltt}


Pakkerne markeres med block eller pass indtil sidste regel\\
nøgleordet \emph{quick} afslutter match - god til store regelsæt

\slide{Linux iptables/netfilter eksempel}

\begin{alltt}\footnotesize
# Firewall configuration written by system-config-securitylevel
# Manual customization of this file is not recommended.
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:RH-Firewall-1-INPUT - [0:0]
-A INPUT -j RH-Firewall-1-INPUT
-A FORWARD -j RH-Firewall-1-INPUT
-A RH-Firewall-1-INPUT -i lo -j ACCEPT
-A RH-Firewall-1-INPUT -p icmp --icmp-type any -j ACCEPT
-A RH-Firewall-1-INPUT -p 50 -j ACCEPT
-A RH-Firewall-1-INPUT -p 51 -j ACCEPT
-A RH-Firewall-1-INPUT -p udp --dport 5353 -d 224.0.0.251 -j ACCEPT
-A RH-Firewall-1-INPUT -p udp -m udp --dport 631 -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A RH-Firewall-1-INPUT -j REJECT --reject-with icmp-host-prohibited
COMMIT
\end{alltt}

\centerline{NB: husk at aktivere IP forwarding}

\slide{Firewalls og ICMP}

\begin{alltt}
ipfw add allow icmp from any to any icmptypes 3,4,11,12
\end{alltt}

\begin{list1}
\item Ovenstående er IPFW syntaks for at tillade de interessant ICMP beskeder igennem
\item Tillad ICMP types:
\begin{list2}
\item 3 Destination Unreachable
\item 4 Source Quench Message
\item 11 Time Exceeded
\item 12 Parameter Problem Message
\end{list2}
\end{list1}

\slide{Firewall konfiguration}

\begin{list1}
\item Den bedste firewall konfiguration starter med:
\begin{list2}
\item Papir og blyant
\item En fornuftig adressestruktur
\end{list2}
\item Brug dernæst en firewall med GUI første gang!
\item Husk dernæst:
\begin{list2}
\item En firewall skal passes
\item En firewall skal opdateres
\item Systemerne bagved skal hærdes!
\end{list2}
\end{list1}

\slide{Bloker indefra og ud}

\begin{list1}
\item Der er porte og services som altid bør blokeres
\item Det kan være kendte sårbare services
\begin{list2}
\item Windows SMB filesharing - ikke til brug på Internet!
\item UNIX NFS - ikke til brug på Internet!
\end{list2}
\item Kendte problemer som minimum
\end{list1}


\slide{En typisk firewall konfiguration}

\hlkimage{14cm}{images/firma-netvaerk.pdf}

\centerline{Opdeling i separate netværkssegmenter!}

\slide{Specielle features}

\begin{list2}
\item Network Address Translation - NAT
\item IPv6 funktionalitet

\item Båndbredde håndtering
\item VLAN funktionalitet - mere udbredt i forbindelse med VoIP
\item Redundante firewalls - pfsync og CARP
% pfsync giver et indblik i hvordan den slags kan laves, hvor de
% kommercielle ``bare kan det''
\item IPsec og Andre VPN features
\item inspection - diverse muligheder for at lave deep inspection i protokoller
\item Eksemplvis DNS inspection
\end{list2}

\slide{Proxy servers}

\begin{list1}
\item Filtrering på højere niveauer i OSI modellen er muligt
\item Idag findes proxy applikationer til de mest almindelige
  funktioner
\item Den typiske proxy er en caching webproxy der kan foretage HTTP
  request på vegne af arbejdsstationer og gemme resultatet
\item NB: nogle protokoller egner sig ikke til proxy servere
\item SSL forbindelser til \emph{secure websites} kan per design ikke proxies
\end{list1}

\slide{IPsec og Andre VPN features}

\begin{list1}
\item De fleste firewalls giver mulighed for at lave krypterede
  tunneler
\item Nyttigt til fjernkontorer der skal have usikker traffik henover
  usikre netværk som Internet
\item Konceptet kaldes Virtual Private Network VPN
\item IPsec er de facto standarden for VPN og beskrevet i RFC'er
\end{list1}


\exercise{ex:nmap-service}
\exercise{ex:nmap-strategy}
\exercise{ex:nmap-html}


\slide{Firewalls og IPv6}

\begin{list1}
\item Læg mærke til forskellen mellem ARP og ICMPv6
\item Hvis det er muligt lav een regel der tillader adgang til services uanset protokol
\item NB: husk at aktivere IP forwarding når I skal lave en firewall
\end{list1}


\slide{ IPv6 neighbor discovery protocol (NDP)}

\hlkimage{14cm}{ipv6-arp-ndp.pdf}

\begin{list1}
\item ARP er væk
\item NDP erstatter og udvider ARP, Sammenlign \verb+arp -an+ med \verb+ndp -an+
\item Til dels erstatter ICMPv6 således DHCP i IPv6, DHCPv6 findes dog
\item {\bf NB: bemærk at dette har stor betydning for firewallregler!}
\end{list1}

\slide{ARP vs NDP}

\begin{alltt}
\small
hlk@bigfoot:basic-ipv6-new$ arp -an
? (10.0.42.1) at{\bf 0:0:24:c8:b2:4c} on en1 [ethernet]
? (10.0.42.2) at 0:c0:b7:6c:19:b on en1 [ethernet]
hlk@bigfoot:basic-ipv6-new$ ndp -an
Neighbor                      Linklayer Address  Netif Expire    St Flgs Prbs
::1                           (incomplete)         lo0 permanent R
2001:16d8:ffd2:cf0f:21c:b3ff:fec4:e1b6 0:1c:b3:c4:e1:b6 en1 permanent R
fe80::1%lo0                   (incomplete)         lo0 permanent R
fe80::200:24ff:fec8:b24c%en1 {\bf 0:0:24:c8:b2:4c}      en1 8h54m51s  S  R
fe80::21c:b3ff:fec4:e1b6%en1  0:1c:b3:c4:e1:b6     en1 permanent R
\end{alltt}




\slide{OpenBSD PF IPv6 NDP}
\begin{alltt}\footnotesize
# Macros: define common values, so they can be referenced and changed easily.
int_if=vr0
ext_if=vr2
tunnel_if=gif0
table <homenet6> { 2001:16d8:ffd2:cf0f::/64 }
set skip on lo0
scrub in all
# Filtering: the implicit first two rules are
block in all

# allow ICMPv6 for NDP
# server with configured IP address and router advertisement daemon running
pass in inet6 proto ipv6-icmp all icmp6-type neighbradv keep state
pass out inet6 proto ipv6-icmp all icmp6-type routersol keep state

# client which uses autoconfiguration would use this instead
#pass in inet6 proto ipv6-icmp all icmp6-type routeradv keep state
#pass out inet6 proto ipv6-icmp all icmp6-type neighbrsol keep state

...  probably not working AS IS
\end{alltt}


\slide{Redundante firewalls}

.
\hlkrightpic{8cm}{0cm}{images/pfsync-carp-1.jpg}

\begin{list2}
\item Mange producenter giver mulighed for redundante firewalls/routere
\item Eksempler VRRP, CARP, HSRP Cisco, VARP Arista
\item OpenBSD Common Address Redundancy Protocol CARP - både IPv4 og IPv6\\
overtagelse af adresse både IPv4 og IPv6
\item pfsync - sender opdateringer om firewall states mellem de to systemer
\end{list2}


\slide{Redundante forbindelser IP-niveau}

\hlkimage{5cm}{router-redundancy-1.pdf}

\begin{list1}
\item HSRP Hot Standby Router Protocol, Cisco protokol, RFC-2281
\item VRRP Virtual Router Redundancy Protocol, IETF RFC-3768, åben standard - ikke fri
\item CARP Common Address Redundancy Protocol, findes på OpenBSD og FreeBSD
\item \link{http://en.wikipedia.org/wiki/Common_Address_Redundancy_Protocol}
\end{list1}


\slidenext

\end{document}
